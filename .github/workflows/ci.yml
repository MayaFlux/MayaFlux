name: MayaFlux CI
on:
  workflow_dispatch: # Manual trigger only
    inputs:
      run_tests:
        description: "Run tests after build"
        required: false
        default: true
        type: boolean
  push:
    branches: [main]
env:
  BUILD_TYPE: Release
jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-14 # Apple Clang 15 with C++23 support
            name: "macOS 14 System Clang (Minimum)"
          - os: macos-latest # Current runner - latest C++23 features
            name: "macOS Latest System Clang"

    runs-on: ${{ matrix.os }}
    name: ${{ matrix.name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check system Clang C++23 support
        shell: bash
        run: |
          echo "=== System Clang Version ==="
          clang++ --version
          echo "=== Testing C++23 standard library support ==="
          cat > test.cpp << 'EOF'
          #include <ranges>
          #include <vector>
          #include <cstddef>
          int main() {
              auto x = 42UZ;  // UZ suffix
              auto v = std::views::iota(0, 5) | std::ranges::to<std::vector>();
              return 0;
          }
          EOF
          clang++ -std=c++2b test.cpp -o test && echo "‚úÖ C++23 features work" || (echo "‚ùå C++23 features failed" && exit 1)

      - name: Install Homebrew tools (cached)
        uses: tecolicom/actions-use-homebrew-tools@v1
        with:
          tools: >
            cmake
            rtaudio
            ffmpeg
            googletest
            pkg-config
            eigen
            onedpl
            magic_enum
            fmt
            glfw
            glm
            llvm
          verbose: true

      - name: Install LLVM via Homebrew
        run: |
          LLVM_PREFIX=$(brew --prefix llvm)
          echo "LLVM_PREFIX=$LLVM_PREFIX" >> $GITHUB_ENV
          echo "PATH=$LLVM_PREFIX/bin:$PATH" >> $GITHUB_ENV
          echo "CMAKE_PREFIX_PATH=$LLVM_PREFIX/lib/cmake:$CMAKE_PREFIX_PATH" >> $GITHUB_ENV

      - name: Install Vulkan SDK (LunarG)
        uses: jakoch/install-vulkan-sdk-action@v1
        with:
          cache: true
          install_runtime: true

      - name: Verify Vulkan SDK
        run: |
          echo "VULKAN_SDK=$VULKAN_SDK"

      - name: Configure CMake
        shell: bash
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_CXX_STANDARD=23 \
            -DCMAKE_VERBOSE_MAKEFILE=ON

      - name: Build
        shell: bash
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel 4

      - name: Test (conditional)
        if: ${{ inputs.run_tests != false }}
        shell: bash
        working-directory: build
        run: ctest --output-on-failure --parallel 4

      - name: Install to staging directory
        if: ${{ inputs.create_distribution != false }}
        shell: bash
        run: |
          mkdir -p dist_staging
          cmake --install build --prefix dist_staging
          echo "Installation completed to dist_staging/"

      - name: Verify installation structure
        if: ${{ inputs.create_distribution != false }}
        shell: bash
        run: |
          echo "=== MayaFlux Distribution Structure ==="
          echo "MayaFluxLib (Core Library):"
          find dist_staging/include/MayaFlux -name "*.hpp" | head -5 || echo "No MayaFlux headers found"
          find dist_staging/lib -name "*MayaFlux*" | head -5 || echo "No MayaFlux libraries found"

          echo ""
          echo "Lila (JIT Interface):"
          find dist_staging/include/Lila -name "*.hpp" | head -5 || echo "No Lila headers found"
          find dist_staging/lib -name "*Lila*" | head -5 || echo "No Lila libraries found"

          echo ""
          echo "lila_server (User Executable):"
          find dist_staging/bin -name "*lila_server*" | head -5 || echo "No lila_server found"

          echo ""
          echo "Runtime (JIT Context):"
          find dist_staging/share/lila/runtime -type f | head -5 || echo "No runtime files found"

      - name: Create MayaFlux distribution package
        if: ${{ inputs.create_distribution != false }}
        shell: bash
        run: |
          # Extract version from CMake
          VERSION=$(grep "project(MayaFlux VERSION" CMakeLists.txt | sed -n 's/.*VERSION \([0-9.]*\).*/\1/p')
          SHORT_SHA=${GITHUB_SHA:0:8}
          OS_NAME="${{ matrix.os }}"

          # Create descriptive package name
          PACKAGE_NAME="MayaFlux-${VERSION}-${OS_NAME}-${SHORT_SHA}"

          # Create comprehensive README
          cat > dist_staging/README.md << EOF
          # MayaFlux Distribution

          Complete MayaFlux platform distribution containing three integrated components:

          ## üèóÔ∏è 1. MayaFluxLib (Core Library)
          - **Purpose**: Core graphics and computation engine for developers
          - **Location**: 
            - Headers: \`include/MayaFlux/\`
            - Library: \`lib/libMayaFluxLib.dylib\`
          - **Use Case**: Direct integration for applications requiring advanced graphics/compute

          ## ‚ö° 2. Lila (JIT Interface) 
          - **Purpose**: Just-In-Time compilation interface that binds to MayaFluxLib
          - **Location**:
            - Headers: \`include/Lila/\`
            - Library: \`lib/libLila.dylib\`
          - **Use Case**: Developer tool for dynamic code execution and JIT compilation

          ## üöÄ 3. lila_server (User Application)
          - **Purpose**: Ready-to-use server application wrapping Lila + MayaFluxLib
          - **Location**: \`bin/lila_server\`
          - **Use Case**: End-user application for interactive development and execution

          ## üîß Runtime Dependencies
          - **Purpose**: Essential files for Lila JIT context
          - **Location**: \`share/lila/runtime/\`

          ## Quick Start
          \`\`\`bash
          # Run the user-facing server
          ./bin/lila_server

          # Develop against MayaFluxLib
          #include <MayaFlux/MayaFlux.hpp>

          # Develop against Lila JIT interface  
          #include <Lila/Lila.hpp>
          \`\`\`

          Build Details:
          - Version: ${VERSION}
          - Platform: ${OS_NAME}
          - Commit: ${GITHUB_SHA}
          - Build Date: $(date -u)
          EOF

          # Create verification script
          cat > dist_staging/verify_components.sh << 'EOF'
          #!/bin/bash
          echo "=== MayaFlux Distribution Verification ==="
          echo ""

          echo "üîç 1. Checking MayaFluxLib (Core Library):"
          if find include/MayaFlux -name "*.hpp" | head -1 > /dev/null; then
              echo "   ‚úÖ Headers found: $(find include/MayaFlux -name "*.hpp" | wc -l) files"
          else
              echo "   ‚ùå No MayaFluxLib headers found"
          fi

          if find lib -name "*MayaFluxLib*" | head -1 > /dev/null; then
              echo "   ‚úÖ Library found: $(find lib -name "*MayaFluxLib*")"
          else
              echo "   ‚ùå No MayaFluxLib library found"
          fi

          echo ""
          echo "üîç 2. Checking Lila (JIT Interface):"
          if find include/Lila -name "*.hpp" | head -1 > /dev/null; then
              echo "   ‚úÖ Headers found: $(find include/Lila -name "*.hpp" | wc -l) files"
          else
              echo "   ‚ùå No Lila headers found"
          fi

          if find lib -name "*Lila*" | head -1 > /dev/null; then
              echo "   ‚úÖ Library found: $(find lib -name "*Lila*")"
          else
              echo "   ‚ùå No Lila library found"
          fi

          echo ""
          echo "üîç 3. Checking lila_server (User Application):"
          if find bin -name "*lila_server*" | head -1 > /dev/null; then
              echo "   ‚úÖ Executable found: $(find bin -name "*lila_server*")"
          else
              echo "   ‚ùå No lila_server executable found"
          fi

          echo ""
          echo "üîç 4. Checking Runtime (JIT Context):"
          if find share/lila/runtime -name "*.h" | head -1 > /dev/null; then
              echo "   ‚úÖ Runtime files found: $(find share/lila/runtime -type f | wc -l) files"
          else
              echo "   ‚ùå No runtime files found"
          fi

          echo ""
          echo "=== Verification Complete ==="
          EOF
          chmod +x dist_staging/verify_components.sh

          # Create packages
          tar -czf "${PACKAGE_NAME}.tar.gz" -C dist_staging .
          zip -r "${PACKAGE_NAME}.zip" dist_staging/

          echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV
          echo "Created distribution packages:"
          ls -la *.tar.gz *.zip

      - name: Upload MayaFlux distribution
        if: ${{ inputs.create_distribution != false }}
        uses: actions/upload-artifact@v4
        with:
          name: mayaflux-distribution-${{ matrix.os }}
          path: |
            ${{ env.PACKAGE_NAME }}.tar.gz
            ${{ env.PACKAGE_NAME }}.zip
          retention-days: 30

      - name: Display distribution summary
        if: ${{ inputs.create_distribution != false }}
        run: |
          echo "=== MayaFlux Distribution Created ==="
          echo "üì¶ Package: ${{ env.PACKAGE_NAME }}"
          echo ""
          echo "Contains three integrated components:"
          echo "  1. üèóÔ∏è  MayaFluxLib - Core graphics/compute engine"
          echo "  2. ‚ö° Lila - JIT interface binding to MayaFluxLib" 
          echo "  3. üöÄ lila_server - User application wrapping both"
          echo ""
          echo "Archive includes:"
          echo "  - Headers for MayaFluxLib and Lila"
          echo "  - Shared libraries"
          echo "  - lila_server executable"
          echo "  - Runtime files for JIT context"
          echo "  - Verification scripts and documentation"

      - name: Upload build artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.os }}
          path: |
            build/CMakeFiles/CMakeOutput.log
            build/CMakeFiles/CMakeError.log
            build/Testing/Temporary/LastTest.log
            build/compile_commands.json
