name: "Build Windows Distribution"

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      clean_version:
        required: true
        type: string
      is_dev:
        required: true
        type: string
      run_tests:
        required: false
        type: boolean
        default: false
      create_distribution:
        required: false
        type: boolean
        default: true
      artifact_name:
        required: true
        type: string
      distribution_name:
        required: true
        type: string
      os_display_name:
        required: true
        type: string

env:
  BUILD_TYPE: RelWithDebInfo
  VCVARS_PATH: 'C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat'
  VCPKG_ROOT: ${{ github.workspace }}/vcpkg
  LLVM_ROOT: "C:/LLVM_CI"

jobs:
  build:
    runs-on: windows-2022
    name: "Windows 2022 (MSVC 2022, x64)"

    steps:
      # ============================================
      # PHASE 1: Environment Setup & Verification
      # ============================================
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use version
        run: echo "Version is ${{ inputs.version }}"

      - name: Verify system prerequisites
        shell: pwsh
        run: |
          Write-Host "=== Verifying System Prerequisites ===" -ForegroundColor Cyan

          $failedChecks = @()

          function Test-Command($cmd) {
            return [bool](Get-Command $cmd -ErrorAction SilentlyContinue)
          }

          function Test-Prerequisite($name, $test) {
            if (& $test) {
              Write-Host "  ✓ $name" -ForegroundColor Green
              return $true
            } else {
              Write-Host "  ✗ $name" -ForegroundColor Red
              return $false
            }
          }

          # Individual checks
          $results = @(
            @{Name="CMake"; Test={ Test-Command "cmake" }},
            @{Name="Git"; Test={ Test-Command "git" }},
            @{Name="7-Zip"; Test={ Get-Command "7z" -ErrorAction SilentlyContinue }},
            @{Name="MSVC 2022"; Test={ Test-Path "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC" }}
          )

          foreach ($check in $results) {
            if (-not (Test-Prerequisite $check.Name $check.Test)) {
              $failedChecks += $check.Name
            }
          }

          if ($failedChecks.Count -gt 0) {
            Write-Host "`n❌ Missing prerequisites: $($failedChecks -join ', ')" -ForegroundColor Red
            exit 1
          } else {
            Write-Host "`n✅ All prerequisites verified successfully" -ForegroundColor Green
          }

      - name: Setup MSVC environment
        shell: cmd
        run: |
          echo "Setting up Visual Studio 2022 environment..."
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x64
          echo "MSVC environment ready"

      - name: Optimize build environment for performance
        shell: pwsh
        run: |
          Write-Host "=== Optimizing Build Environment ===" -ForegroundColor Cyan

          # Disable Windows Defender for build directories
          Set-MpPreference -DisableRealtimeMonitoring $true -ErrorAction SilentlyContinue
          Add-MpPreference -ExclusionPath "${{ github.workspace }}" -ErrorAction SilentlyContinue
          Add-MpPreference -ExclusionPath "${{ env.VCPKG_ROOT }}" -ErrorAction SilentlyContinue
          Add-MpPreference -ExclusionPath "${{ env.LLVM_ROOT }}" -ErrorAction SilentlyContinue

          # Exclude build tools from scanning
          Add-MpPreference -ExclusionProcess "cl.exe" -ErrorAction SilentlyContinue
          Add-MpPreference -ExclusionProcess "link.exe" -ErrorAction SilentlyContinue
          Add-MpPreference -ExclusionProcess "cmake.exe" -ErrorAction SilentlyContinue
          Add-MpPreference -ExclusionProcess "7z.exe" -ErrorAction SilentlyContinue

          Write-Host "✓ Build optimizations applied" -ForegroundColor Green

      - name: Create DIA SDK symlink for LLVM compatibility
        shell: pwsh
        run: |
          Write-Host "Creating DIA SDK symlink for LLVM..." -ForegroundColor Yellow

          $targetPath = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\DIA SDK"
          $linkPath = "C:\Program Files (x86)\Microsoft Visual Studio\2019\Professional\DIA SDK"

          # Create parent directories if they don't exist
          $linkParent = Split-Path $linkPath -Parent
          if (-not (Test-Path $linkParent)) {
            New-Item -ItemType Directory -Path $linkParent -Force | Out-Null
          }

          # Create directory junction (symlink)
          if (-not (Test-Path $linkPath)) {
            New-Item -ItemType Junction -Path $linkPath -Target $targetPath -Force
            Write-Host "✓ Created symlink: $linkPath -> $targetPath" -ForegroundColor Green
          } else {
            Write-Host "✓ Symlink already exists" -ForegroundColor Green
          }

          # Verify
          if (Test-Path "$linkPath\lib\amd64\diaguids.lib") {
            Write-Host "✓ DIA SDK accessible via symlink" -ForegroundColor Green
          } else {
            Write-Host "✗ DIA SDK verification failed" -ForegroundColor Red
            exit 1
          }

      # ============================================
      # PHASE 2: Dependency Management (Parallelizable)
      # ============================================
      - name: Cache vcpkg
        uses: actions/cache@v4
        id: vcpkg-cache
        with:
          path: ${{ env.VCPKG_ROOT }}
          key: vcpkg-${{ runner.os }}-${{ hashFiles('.github/workflows/vcpkg.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Cache LLVM
        uses: actions/cache@v4
        id: llvm-cache
        with:
          path: ${{ env.LLVM_ROOT }}
          key: llvm-21.1.8-windows-x64
          restore-keys: llvm-21.1.8-windows-x64

      - name: Cache FFmpeg
        uses: actions/cache@v4
        id: ffmpeg-cache
        with:
          path: C:\Program Files\FFmpeg
          key: ffmpeg-6.0-windows-x64
          restore-keys: |
            ffmpeg-6.0-windows-

      # ============================================
      # Install Dependencies (Conditional on Cache Miss)
      # ============================================

      - name: Install vcpkg and dependencies
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          Write-Host "=== Installing vcpkg and dependencies ===" -ForegroundColor Magenta

          git clone https://github.com/Microsoft/vcpkg.git ${{ env.VCPKG_ROOT }}
          & "${{ env.VCPKG_ROOT }}\bootstrap-vcpkg.bat"

          cd ${{ github.workspace }}/.github/workflows
          & "${{ env.VCPKG_ROOT }}\vcpkg.exe" install `
            --triplet x64-windows `
            --x-install-root=${{ env.VCPKG_ROOT }}/installed `
            --clean-buildtrees-after-build

          Write-Host "✓ vcpkg setup complete" -ForegroundColor Green

      - name: Install LLVM 21 (Lila JIT)
        if: steps.llvm-cache.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          Write-Host "=== Installing LLVM 21 (Lila JIT Requirement) ===" -ForegroundColor Magenta

          $tempDir = Join-Path $env:TEMP "llvm_ci_download"
          $downloadFile = Join-Path $tempDir "llvm-21.1.8.tar.xz"
          $llvmUrl = "https://github.com/llvm/llvm-project/releases/download/llvmorg-21.1.8/clang+llvm-21.1.8-x86_64-pc-windows-msvc.tar.xz"

          New-Item -ItemType Directory -Path $tempDir -Force | Out-Null
          New-Item -ItemType Directory -Path ${{ env.LLVM_ROOT }} -Force | Out-Null

          # Download LLVM
          Invoke-WebRequest -Uri $llvmUrl -OutFile $downloadFile -UseBasicParsing -TimeoutSec 600

          # Extract
          7z x $downloadFile -o"$tempDir" | Out-Null
          $tarFile = Get-ChildItem $tempDir -Filter "*.tar" | Select-Object -First 1
          7z x $tarFile.FullName -o"$tempDir" | Out-Null

          # Move to installation directory
          $extracted = Get-ChildItem $tempDir -Directory | Where-Object { $_.Name -match "clang\+llvm" } | Select-Object -First 1
          Copy-Item -Path "$($extracted.FullName)\*" -Destination ${{ env.LLVM_ROOT }} -Recurse -Force
          # Verify
          if (Test-Path "${{ env.LLVM_ROOT }}\lib\LLVMCore.lib") {
            Write-Host "✓ LLVM 21 installed" -ForegroundColor Green
          } else {
            Write-Host "✗ LLVM installation verification failed" -ForegroundColor Red
            exit 1
          }

          Remove-Item $tempDir -Recurse -Force -ErrorAction SilentlyContinue

      - name: Install FFmpeg
        if: steps.ffmpeg-cache.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          Write-Host "=== Installing FFmpeg ===" -ForegroundColor Yellow

          $tempDir = Join-Path $env:TEMP "ffmpeg_ci"
          $downloadFile = Join-Path $tempDir "ffmpeg.7z"
          $ffmpegUrl = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-full-shared.7z"

          New-Item -ItemType Directory -Path $tempDir -Force | Out-Null
          New-Item -ItemType Directory -Path "C:\Program Files\FFmpeg" -Force | Out-Null

          Invoke-WebRequest -Uri $ffmpegUrl -OutFile $downloadFile -UseBasicParsing -TimeoutSec 300
          7z x $downloadFile -o"$tempDir" | Out-Null

          $extracted = Get-ChildItem $tempDir -Directory | Where-Object { $_.Name -match "ffmpeg" } | Select-Object -First 1
          Copy-Item -Path "$($extracted.FullName)\*" -Destination "C:\Program Files\FFmpeg" -Recurse -Force

          if (Test-Path "C:\Program Files\FFmpeg\bin\ffmpeg.exe") {
            Write-Host "✓ FFmpeg installed" -ForegroundColor Green
          } else {
            throw "FFmpeg installation verification failed"
          }

      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1
        with:
          cache: true
          install_runtime: true

      # ============================================
      # PHASE 3: Build Configuration
      # ============================================

      - name: Set environment variables
        shell: pwsh
        run: |
          Write-Host "=== Setting Environment Variables ===" -ForegroundColor Cyan

          # vcpkg environment
          echo "VCPKG_INSTALLED_DIR=${{ env.VCPKG_ROOT }}\installed" >> $env:GITHUB_ENV
          echo "CMAKE_TOOLCHAIN_FILE=${{ env.VCPKG_ROOT }}\scripts\buildsystems\vcpkg.cmake" >> $env:GITHUB_ENV

          # LLVM environment
          echo "LLVM_CI_PATH=${{ env.LLVM_ROOT }}" >> $env:GITHUB_ENV

          # FFmpeg environment
          echo "FFMPEG_ROOT=C:\Program Files\FFmpeg" >> $env:GITHUB_ENV

          Write-Host "✓ Environment variables set" -ForegroundColor Green

      - name: Configure CMake
        shell: pwsh
        run: |
          Write-Host "=== Configuring CMake ===" -ForegroundColor Cyan

          $cmakeArgs = @(
            "-B", "build",
            "-G", "Visual Studio 17 2022",
            "-A", "x64",
            "-DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}",
            "-DCMAKE_CONFIGURATION_TYPES=${{ env.BUILD_TYPE }}",
            "-DCMAKE_CXX_STANDARD=23",
            "-DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON",
            "-DCMAKE_TOOLCHAIN_FILE=${{ env.VCPKG_ROOT }}\scripts\buildsystems\vcpkg.cmake",
            "-DCMAKE_CXX_FLAGS_RELEASE=/O2 /DNDEBUG /Z7",
            "-DCMAKE_EXE_LINKER_FLAGS=/DEBUG:FASTLINK"
          )

          # LLVM configuration
          if ($env:LLVM_CI_PATH) {
            $cmakeArgs += @("-DLLVM_DIR=$env:LLVM_CI_PATH\lib\cmake\llvm")
            $cmakeArgs += @("-DClang_DIR=$env:LLVM_CI_PATH\lib\cmake\clang")
          }

          Write-Host "CMake arguments:" -ForegroundColor Yellow
          $cmakeArgs | ForEach-Object { Write-Host "  $_" -ForegroundColor Gray }

          cmake @cmakeArgs

      # ============================================
      # PHASE 4: Build & Distribution
      # ============================================

      - name: Build
        shell: pwsh
        run: |
          Write-Host "=== Building MayaFlux ===" -ForegroundColor Cyan
          cmake --build build --config ${{ env.BUILD_TYPE }} --parallel $([System.Environment]::ProcessorCount)

      # - name: Run Tests (optional)
      #   if: ${{ inputs.run_tests != false }}
      #   shell: pwsh
      #   working-directory: build
      #   run: ctest --output-on-failure --parallel 4

      - name: Install to staging directory
        # if: ${{ inputs.create_distribution != false }}
        shell: pwsh
        run: |
          cmake --install build --prefix dist_staging --config ${{ env.BUILD_TYPE }}
          Write-Host "✓ Installation completed to dist_staging/" -ForegroundColor Green

      - name: Verify version file
        shell: bash
        run: |
          echo "=== Version Metadata ==="
          if [ -f "dist_staging/share/MayaFlux/.version" ]; then
            cat dist_staging/share/MayaFlux/.version
          else
            echo "WARNING: .version file not generated!"
          fi

      - name: Bundle runtime DLLs
        # if: ${{ inputs.create_distribution != false }}
        shell: pwsh
        run: |
          Write-Host "=== Bundling Runtime DLLs ===" -ForegroundColor Magenta

          $binDir = "dist_staging\bin"
          New-Item -ItemType Directory -Path $binDir -Force | Out-Null

          # vcpkg DLLs
          if ($env:VCPKG_INSTALLED_DIR) {
            $vcpkgBin = "$env:VCPKG_INSTALLED_DIR\x64-windows\bin"
            if (Test-Path $vcpkgBin) {
              Copy-Item -Path "$vcpkgBin\*.dll" -Destination $binDir -Force
            }
          }

          # LLVM DLLs
          if ($env:LLVM_CI_PATH) {
            Copy-Item -Path "$env:LLVM_CI_PATH\bin\*.dll" -Destination $binDir -Force
          }

          # Vulkan DLLs
          if ($env:VULKAN_SDK) {
            Copy-Item -Path "$env:VULKAN_SDK\Bin\*.dll" -Destination $binDir -Force
          }

          $dllCount = @(Get-ChildItem $binDir -Filter *.dll).Count
          Write-Host "✓ DLLs bundled: $dllCount files" -ForegroundColor Green

      - name: Copy distribution assets
        # if: ${{ inputs.create_distribution != false }}
        shell: pwsh
        run: |
          Write-Host "=== Copying Distribution Assets ===" -ForegroundColor Magenta

          # Copy pre-made distribution files
          $distAssets = ".github/workflows/distribution/windows"
          if (Test-Path $distAssets) {
            Copy-Item -Path "$distAssets/*" -Destination "dist_staging/" -Recurse -Force
            Write-Host "✓ Distribution assets copied" -ForegroundColor Green
          } else {
            Write-Host "⚠ Distribution assets not found at: $distAssets" -ForegroundColor Yellow
          }

      - name: Create distribution package
        if: ${{ inputs.create_distribution != false }}
        shell: pwsh
        run: |
          Write-Host "=== Creating Distribution Package ===" -ForegroundColor Magenta

          $version = "${{ inputs.version }}"
          $shortSha = $env:GITHUB_SHA.Substring(0, 8)
          $osName  = "${{ inputs.distribution_name }}"
          $packageName = "MayaFlux-${version}-${osName}"

          # Create packages
          Write-Host "Creating archives..." -ForegroundColor Yellow
          7z a -mx=9 "${packageName}.7z" "dist_staging\*" | Out-Null

          echo "PACKAGE_NAME=$packageName" >> $env:GITHUB_ENV

          $size = [math]::Round((Get-Item "${packageName}.7z").Length / 1MB, 2)
          Write-Host "✓ Created ${packageName}.7z: ${size} MB" -ForegroundColor Green

      - name: Verify installation structure
        if: ${{ inputs.create_distribution != false }}
        shell: pwsh
        run: |
          Write-Host "`n=== MayaFlux Windows Distribution Structure ===" -ForegroundColor Cyan

          Write-Host "`nMayaFluxLib (Core Library):" -ForegroundColor Yellow
          $headerCount = @(Get-ChildItem -Path "dist_staging\include\MayaFlux" -Recurse -Filter "*.hpp" -ErrorAction SilentlyContinue).Count
          Write-Host "  Headers: $headerCount files"
          if (Test-Path "dist_staging\lib\MayaFluxLib.lib") {
            Write-Host "  ✓ MayaFluxLib.lib (import library)"
          }
          if (Test-Path "dist_staging\bin\MayaFluxLib.dll") {
            Write-Host "  ✓ MayaFluxLib.dll (runtime)"
          }

          Write-Host "`nLila (JIT Interface):" -ForegroundColor Yellow
          $lilaHeaders = @(Get-ChildItem -Path "dist_staging\include\Lila" -Recurse -Filter "*.hpp" -ErrorAction SilentlyContinue).Count
          Write-Host "  Headers: $lilaHeaders files"
          if (Test-Path "dist_staging\lib\Lila.lib") {
            Write-Host "  ✓ Lila.lib (import library)"
          }
          if (Test-Path "dist_staging\bin\Lila.dll") {
            Write-Host "  ✓ Lila.dll (runtime)"
          }

          Write-Host "`nlila_server (User Application):" -ForegroundColor Yellow
          if (Test-Path "dist_staging\bin\lila_server.exe") {
            $fileInfo = Get-Item "dist_staging\bin\lila_server.exe"
            $sizeMB = [math]::Round($fileInfo.Length / 1MB, 2)
            Write-Host "  ✓ lila_server.exe (${sizeMB} MB)"
          }

          Write-Host "`nRuntime DLLs (Bundled):" -ForegroundColor Yellow
          $dlls = @(Get-ChildItem -Path "dist_staging\bin" -Filter "*.dll" -ErrorAction SilentlyContinue)
          Write-Host "  Count: $($dlls.Count) DLLs"
          if ($dlls.Count -gt 0) {
            Write-Host "  Key DLLs:" -ForegroundColor Gray
            $dlls | Where-Object { $_.Name -match "(LLVM|clang|ffmpeg|glfw|rtaudio|vulkan|hidapi)" } | ForEach-Object {
              Write-Host "    - $($_.Name)"
            }
          }

          Write-Host "`nShader/Runtime Resources:" -ForegroundColor Yellow
          $shareDir = Test-Path "dist_staging\share"
          if ($shareDir) {
            $files = @(Get-ChildItem -Path "dist_staging\share" -Recurse -File -ErrorAction SilentlyContinue)
            Write-Host "  Runtime files: $($files.Count) files"
          }

      - name: Upload MayaFlux distribution
        if: ${{ inputs.create_distribution != false }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: ${{ env.PACKAGE_NAME }}.7z
          retention-days: 30

      - name: Display build summary
        shell: pwsh
        run: |
          Write-Host "`n" -ForegroundColor White
          Write-Host "╔═══════════════════════════════════════════════════════════════╗" -ForegroundColor Cyan
          Write-Host "║         MayaFlux Windows CI Build Complete                    ║" -ForegroundColor Cyan
          Write-Host "╚═══════════════════════════════════════════════════════════════╝" -ForegroundColor Cyan

          if (Test-Path "build\CMakeCache.txt") {
            Write-Host "`n✓ Build configuration: SUCCESS" -ForegroundColor Green
          }

          Write-Host "`nKey Configuration:" -ForegroundColor Yellow
          Write-Host "  Platform: ${{ inputs.os_display_name }}"
          Write-Host "  Compiler: MSVC 2022 (cl.exe)"
          Write-Host "  C++ Standard: C++23"
          Write-Host "  Build Type: ${{ env.BUILD_TYPE }}"

          Write-Host "`nDependencies:" -ForegroundColor Yellow
          Write-Host "  [Tier 1 - Dedicated Routes]" -ForegroundColor Cyan
          Write-Host "  ✓ LLVM 21.1.8 (Lila JIT - manual download + cache)" -ForegroundColor Green
          Write-Host "  ✓ Vulkan SDK (GitHub Action - auto-detected)" -ForegroundColor Green
          Write-Host "  [Tier 2 - vcpkg Package Manager]" -ForegroundColor Cyan
          Write-Host "  ✓ RtAudio 6.0.1 (WASAPI via vcpkg.json)" -ForegroundColor Green
          Write-Host "  ✓ HidApi 0.15.0 (via vcpkg.json)" -ForegroundColor Green
          Write-Host "  ✓ GLFW 3.4 (shared lib via vcpkg.json)" -ForegroundColor Green
          Write-Host "  ✓ FFmpeg 6.0+ (shared libs via vcpkg.json)" -ForegroundColor Green
          Write-Host "  ✓ Eigen3, GLM, magic_enum (via vcpkg.json)" -ForegroundColor Green
          Write-Host "  [Tier 3 - Header-Only Direct]" -ForegroundColor Cyan

          if (Test-Path "${{ env.PACKAGE_NAME }}.7z") {
            $size = [math]::Round((Get-Item "${{ env.PACKAGE_NAME }}.7z").Length / 1MB, 2)
            Write-Host "`nDistribution Package:" -ForegroundColor Yellow
            Write-Host "  ✓ ${{ env.PACKAGE_NAME }}.7z (${size} MB)" -ForegroundColor Green
            Write-Host "  ✓ All runtime DLLs bundled in bin/" -ForegroundColor Green
            Write-Host "  ✓ Ready for standalone deployment" -ForegroundColor Green
          }

          Write-Host "`nNext Steps:" -ForegroundColor Yellow
          Write-Host "  1. Download distribution from Artifacts"
          Write-Host "  2. Extract to target location"
          Write-Host "  3. Run verify.bat to check components"
          Write-Host "  4. Run bin\lila_server.exe or link against MayaFluxLib"
          Write-Host ""

      - name: Upload build artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-logs
          path: |
            build/CMakeFiles/CMakeOutput.log
            build/CMakeFiles/CMakeError.log
            build/compile_commands.json
          retention-days: 7
