#pragma once

#define MAYAFLUX_VERSION "@PROJECT_VERSION@"
#define MAYAFLUX_VERSION_MAJOR @PROJECT_VERSION_MAJOR@
#define MAYAFLUX_VERSION_MINOR @PROJECT_VERSION_MINOR@
#define MAYAFLUX_VERSION_PATCH @PROJECT_VERSION_PATCH@

// Redifinition needed as clang interpreter wont have cmake defines
#if defined(_WIN32) || defined(_WIN64)
#ifndef MAYAFLUX_PLATFORM_WINDOWS
#define MAYAFLUX_PLATFORM_WINDOWS
#endif // MAYAFLUX_PLATFORM_WINDOWS
#elif defined(__APPLE__) || defined(__MACH__)
#ifndef MAYAFLUX_PLATFORM_MACOS
#define MAYAFLUX_PLATFORM_MACOS
#endif // MAYAFLUX_PLATFORM_MACOS
#else
#ifndef MAYAFLUX_PLATFORM_LINUX
#define MAYAFLUX_PLATFORM_LINUX
#endif // MAYAFLUX_PLATFORM_LINUX
#endif

// Cross-platform definitions
#ifdef MAYAFLUX_PLATFORM_WINDOWS
#ifdef ERROR
#undef ERROR
#endif // ERROR
#define MAYAFLUX_FORCEINLINE __forceinline
#define MAYAFLUX_UNREACHABLE() __assume(false)
#define MAYAFLUX_LIKELY(x) (x)
#define MAYAFLUX_UNLIKELY(x) (x)
#else
#define MAYAFLUX_FORCEINLINE __attribute__((always_inline))
#define MAYAFLUX_UNREACHABLE() __builtin_unreachable()
#define MAYAFLUX_LIKELY(x) __builtin_expect(!!(x), 1)
#define MAYAFLUX_UNLIKELY(x) __builtin_expect(!!(x), 0)
#endif

#ifdef _MSC_VER
#define MAYAFLUX_COMPILER_MSVC
#endif

#ifdef __clang__
#define MAYAFLUX_COMPILER_CLANG
#endif

#ifdef __GNUC__
#define MAYAFLUX_COMPILER_GCC
#endif

#if defined(__x86_64__) || defined(_M_X64)
#define MAYAFLUX_ARCH_X64
#elif defined(__aarch64__) || defined(_M_ARM64)
#define MAYAFLUX_ARCH_ARM64
#else
#error "Unknown or unsupported architecture"
#endif

#ifdef MAYAFLUX_PLATFORM_WINDOWS
#if defined(MAYAFLUX_EXPORTS)
#define MAYAFLUX_API __declspec(dllexport)
#else
#define MAYAFLUX_API __declspec(dllimport)
#endif
#else
#define MAYAFLUX_API
#endif

#ifdef MAYAFLUX_PLATFORM_WINDOWS
#if defined(LILA_EXPORTS)
#define LILA_API __declspec(dllexport)
#else
#define LILA_API __declspec(dllimport)
#endif
#else
#define LILA_API
#endif

// C++20 std::format availability detection
#ifdef MAYAFLUX_PLATFORM_MACOS
#define MAYAFLUX_USE_FMT 1
#define MAYAFLUX_USE_STD_FORMAT 0
#else
#if __has_include(<format>) && defined(__cpp_lib_format)
#define MAYAFLUX_USE_STD_FORMAT 1
#define MAYAFLUX_USE_FMT 0
#else
#define MAYAFLUX_USE_FMT 1
#define MAYAFLUX_USE_STD_FORMAT 0
#endif
#endif

#if defined(__x86_64__) || defined(_M_X64) || defined(__i386__) || defined(_M_IX86)

    #if defined(_MSC_VER)
        #include <immintrin.h>
        #define MF_PAUSE_INSTRUCTION() _mm_pause()
    #else
        #define MF_PAUSE_INSTRUCTION() __builtin_ia32_pause()
    #endif

#elif defined(__aarch64__) || defined(_M_ARM64)
    #define MF_PAUSE_INSTRUCTION() __asm__ __volatile__("yield")
#else
    #define MF_PAUSE_INSTRUCTION() ((void)0)
#endif

namespace MayaFlux {

namespace Config {
    constexpr std::string_view SOURCE_DIR = "@CMAKE_SOURCE_DIR@";
    constexpr std::string_view PCH_SOURCE_PATH = "@CMAKE_SOURCE_DIR@/cmake";
    constexpr std::string_view EIGEN_HINT = "@MAYAFLUX_EIGEN_INCLUDE@";
#if defined(MAYAFLUX_PLATFORM_MACOS) && (defined(__aarch64__) || defined(_M_ARM64))
    constexpr std::string_view RUNTIME_DATA_DIR = "/opt/homebrew/share/MayaFlux/runtime";
    constexpr std::string_view PCH_RUNTIME_PATH = "/opt/homebrew/share/MayaFlux/runtime/pch.h";
#else
    constexpr std::string_view RUNTIME_DATA_DIR = "@CMAKE_INSTALL_PREFIX@/share/MayaFlux/runtime";
    constexpr std::string_view PCH_RUNTIME_PATH = "@CMAKE_INSTALL_PREFIX@/share/MayaFlux/runtime/pch.h";
#endif
}

namespace Core {
    constexpr const char* SHADER_BUILD_OUTPUT_DIR = "@SHADER_OUTPUT_DIR@";
    constexpr const char* SHADER_SOURCE_DIR = "@SHADERS_DIR@";
    constexpr const char* SHADER_EXAMPLE_DIR      = "@EXAMPLE_SHADER_DIR@";  // empty string in non-dev builds
#if defined(MAYAFLUX_PLATFORM_MACOS) && (defined(__aarch64__) || defined(_M_ARM64))
    constexpr const char* SHADER_INSTALL_DIR = "/opt/homebrew/share/MayaFlux/shaders";
#else
    constexpr const char* SHADER_INSTALL_DIR = "@CMAKE_INSTALL_PREFIX@/share/MayaFlux/shaders";
#endif
} // namespace Core

} // namespace MayaFlux
