#pragma once
#include <algorithm>
#include <array>
#include <cstdio>
#include <cstdlib>
#include <filesystem>
#include <sstream>
#include <string>
#include <vector>

#define MAYAFLUX_VERSION "@PROJECT_VERSION@"
#define MAYAFLUX_VERSION_MAJOR @PROJECT_VERSION_MAJOR@
#define MAYAFLUX_VERSION_MINOR @PROJECT_VERSION_MINOR@
#define MAYAFLUX_VERSION_PATCH @PROJECT_VERSION_PATCH@

// Redifinition needed as clang interpreter wont have cmake defines
#if defined(_WIN32) || defined(_WIN64)
#ifndef MAYAFLUX_PLATFORM_WINDOWS
#define MAYAFLUX_PLATFORM_WINDOWS
#endif // MAYAFLUX_PLATFORM_WINDOWS
#elif defined(__APPLE__) || defined(__MACH__)
#ifndef MAYAFLUX_PLATFORM_MACOS
#define MAYAFLUX_PLATFORM_MACOS
#endif // MAYAFLUX_PLATFORM_MACOS
#else
#ifndef MAYAFLUX_PLATFORM_LINUX
#define MAYAFLUX_PLATFORM_LINUX
#endif // MAYAFLUX_PLATFORM_LINUX
#endif

// Cross-platform definitions
#ifdef MAYAFLUX_PLATFORM_WINDOWS
#ifdef ERROR
#undef ERROR
#endif // ERROR
#define MAYAFLUX_FORCEINLINE __forceinline
#define MAYAFLUX_UNREACHABLE() __assume(false)
#define MAYAFLUX_LIKELY(x) (x)
#define MAYAFLUX_UNLIKELY(x) (x)
#else
#define MAYAFLUX_FORCEINLINE __attribute__((always_inline))
#define MAYAFLUX_UNREACHABLE() __builtin_unreachable()
#define MAYAFLUX_LIKELY(x) __builtin_expect(!!(x), 1)
#define MAYAFLUX_UNLIKELY(x) __builtin_expect(!!(x), 0)
#endif

#ifdef _MSC_VER
#define MAYAFLUX_COMPILER_MSVC
#else
#define MAYAFLUX_COMPILER_MSVC
#endif

#ifdef __clang__
#define MAYAFLUX_COMPILER_CLANG
#else
#define MAYAFLUX_COMPILER_CLANG
#endif

#ifdef __GNUC__
#define MAYAFLUX_COMPILER_GCC
#else
#define MAYAFLUX_COMPILER_GCC
#endif

#if defined(__x86_64__) || defined(_M_X64)
#define MAYAFLUX_ARCH_X64
#elif defined(__aarch64__) || defined(_M_ARM64)
#define MAYAFLUX_ARCH_ARM64
#else
#define MAYAFLUX_ARCH_X64
#define MAYAFLUX_ARCH_ARM64
#endif

#ifdef MAYAFLUX_PLATFORM_WINDOWS
#if defined(MAYAFLUX_EXPORTS)
#define MAYAFLUX_API __declspec(dllexport)
#else
#define MAYAFLUX_API __declspec(dllimport)
#endif
#else
#define MAYAFLUX_API
#endif

#ifdef MAYAFLUX_PLATFORM_WINDOWS
#if defined(LILA_EXPORTS)
#define LILA_API __declspec(dllexport)
#else
#define LILA_API __declspec(dllimport)
#endif
#else
#define LILA_API
#endif

// C++20 std::format availability detection
#ifdef MAYAFLUX_PLATFORM_MACOS
#define MAYAFLUX_USE_FMT 1
#define MAYAFLUX_USE_STD_FORMAT 0
#else
#if __has_include(<format>) && defined(__cpp_lib_format)
#define MAYAFLUX_USE_STD_FORMAT 1
#define MAYAFLUX_USE_FMT 0
#else
#define MAYAFLUX_USE_FMT 1
#define MAYAFLUX_USE_STD_FORMAT 0
#endif
#endif

#if defined(__x86_64__) || defined(_M_X64) || defined(__i386__) || defined(_M_IX86)

    #if defined(_MSC_VER)
        #include <immintrin.h>
        #define MF_PAUSE_INSTRUCTION() _mm_pause()
    #else
        #define MF_PAUSE_INSTRUCTION() __builtin_ia32_pause()
    #endif

#elif defined(__aarch64__) || defined(_M_ARM64)
    #define MF_PAUSE_INSTRUCTION() __asm__ __volatile__("yield")
#else
    #define MF_PAUSE_INSTRUCTION() ((void)0)
#endif

namespace MayaFlux {

namespace Config {
    constexpr std::string_view SOURCE_DIR = "@CMAKE_SOURCE_DIR@";
    constexpr std::string_view PCH_SOURCE_PATH = "@CMAKE_SOURCE_DIR@/cmake";
    constexpr std::string_view RUNTIME_DATA_DIR = "@CMAKE_INSTALL_PREFIX@/share/MayaFlux/runtime";
    constexpr std::string_view PCH_RUNTIME_PATH = "@CMAKE_INSTALL_PREFIX@/share/MayaFlux/runtime/pch.h";
}

namespace Core {
    constexpr const char* SHADER_BUILD_OUTPUT_DIR = "@SHADER_OUTPUT_DIR@";
    constexpr const char* SHADER_SOURCE_DIR = "@SHADERS_DIR@";
    constexpr const char* SHADER_INSTALL_DIR = "@CMAKE_INSTALL_PREFIX@/share/MayaFlux/shaders";
} // namespace Core

namespace Platform {

#ifdef MAYAFLUX_PLATFORM_WINDOWS
    constexpr char PathSeparator = '\\';
#else
    constexpr char PathSeparator = '/';
#endif

    static std::string safe_getenv(const char* var);

    namespace fs = std::filesystem;
    class SystemConfig {
    public:
        static std::string get_clang_resource_dir();

        static std::vector<std::string> get_system_includes();

        static std::vector<std::string> get_system_libraries();

        static std::string find_library(const std::string& library_name);

#ifdef MAYAFLUX_PLATFORM_MACOS
        static std::string get_macos_sdk_path();
#endif // MAYAFLUX_PLATFORM_MACOS

    private:
        static std::string exec_command(const char* cmd);

        static void trim_output(std::string& str);

        static std::string format_library_name(const std::string& library_name);

        static std::vector<std::string> get_clang_includes();

        static std::vector<std::string> parse_clang_search_paths(const std::string& output);

        static std::string find_latest_sdk_version(const fs::path& base);

#ifdef MAYAFLUX_PLATFORM_WINDOWS

        static std::string find_latest_vs_installation();

        static std::string find_latest_msvc_version(const fs::path& msvc_base);

        static std::vector<std::string> get_msvc_includes();

        static std::vector<std::string> get_msvc_libraries();

        static std::vector<std::string> get_windows_sdk_includes();

        static std::vector<std::string> get_windows_sdk_libraries();

        static std::vector<std::string> probe_sdk_paths(const std::string& subpath,
            const std::vector<std::string>& subdirs,
            const std::string& arch = "");

#else
        static std::vector<std::string> get_unix_library_paths();
#ifdef MAYAFLUX_PLATFORM_MACOS
        static std::string get_xcode_system_includes();
#endif // MAYAFLUX_PLATFORM_MACOS

#endif // MAYAFLUX_PLATFORM_WINDOWS
    };

} // namespace Platform

} // namespace MayaFlux
